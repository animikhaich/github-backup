name: Automated GitHub Account Mirroring & Backup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get GitHub Username
        id: get_user
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          GH_USER=$(gh api user --jq .login)
          echo "GH_USER=$GH_USER" >> $GITHUB_ENV
          echo "Detected GitHub User: $GH_USER"

      - name: Install Gickup
        run: |
          wget -q https://github.com/cooperspencer/gickup/releases/download/v0.10.39/gickup_0.10.39_linux_amd64.tar.gz
          tar -xzf gickup_0.10.39_linux_amd64.tar.gz
          chmod +x gickup
          ./gickup --version

      - name: Generate Gickup Configuration
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_USER_OR_GROUP: ${{ vars.GITLAB_USER_OR_GROUP }}
        run: |
          cat <<EOF > gickup.yml
          source:
            github:
              - token: $GH_TOKEN
                user: $GH_USER
                exclude: []
                wiki: true

          destination:
            gitlab:
              - token: $GITLAB_TOKEN
                url: https://gitlab.com
                user: $GITLAB_USER_OR_GROUP
                mirror:
                  enabled: true
            local:
              - path: ./backup_stage
                structured: true
                bare: true
                mirror: true
          EOF

          # Mask tokens in the log if we were to print this file (we won't print it)

      - name: Run Gickup
        run: ./gickup gickup.yml

      - name: Sync to AWS S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1 # Defaulting, usually standard for S3 if not specified
          S3_BUCKET: ${{ vars.S3_BUCKET_NAME }}
        run: |
          # The local path with structured: true will be ./backup_stage/github/<user>/<repo>.git
          # We want to sync the user folder to the bucket root or bucket/github/<user> depending on preference.
          # PRD implies "folders named repo-name.git" in the bucket.
          # If we sync ./backup_stage/github/$GH_USER/ to s3://$S3_BUCKET/, we get repo.git folders at the root.

          SOURCE_PATH="./backup_stage/github/$GH_USER"

          if [ -d "$SOURCE_PATH" ]; then
            echo "Syncing from $SOURCE_PATH to s3://$S3_BUCKET/"
            aws s3 sync "$SOURCE_PATH" "s3://$S3_BUCKET/" --no-progress
          else
            echo "Directory $SOURCE_PATH does not exist. Listing backup_stage for debugging:"
            ls -R backup_stage || echo "backup_stage not found"
            exit 1
          fi
